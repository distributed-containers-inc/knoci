commands:
  - name: codegen
    command: |
      echo 'Building openapi schema...'
      export PACKAGE=github.com/distributed-containers-inc/knoci
      openapi-gen \
        -i $PACKAGE/pkg/apis/testing/v1alpha1 \
        -p $PACKAGE/pkg/apis/testing/v1alpha1 \
        --report-filename api_violations.list
      if grep -v -e k8s.io/api/ -e k8s.io/apimachinery/ api_violations.list; then
        echo 'Violations found!'
        exit 1
      else
        rm api_violations.list
      fi
      
      echo 'Generating deepcopy functions...'
      deepcopy-gen \
        --input-dirs=${PACKAGE}/pkg/apis/testing/v1alpha1 \
        --output-file-base='zz_deepcopy_generated' \
        --bounding-dirs=${PACKAGE}/pkg/apis

      echo 'Generating clientset...'
      client-gen \
        --input-base "" \
        --input="$PACKAGE/pkg/apis/testing/v1alpha1" \
        --clientset-name="versioned" \
        --output-package="$PACKAGE/pkg/client"

      echo 'Generating listers...'
      lister-gen \
        --input-dirs="${PACKAGE}/pkg/apis/testing/v1alpha1" \
        --output-package="${PACKAGE}/pkg/client/listers"


  - name: update
    command: |
      set -eu -o pipefail
      echo 'Generating sources...'
      sanic run codegen
      sanic build --push
      sanic kubectl delete crd tests.knoci.distributedcontainers.com || true
      sanic deploy


environments:
  dev:
    clusterProvisioner: localdev

build:
  ignoreDirs:
  - example
